-- ==========================================================
-- SCRIPT ROBUSTO: Creación de IESS_USER en XEPDB1 (única vez)
-- ==========================================================

-- ✅ Solo ejecutarse dentro de la PDB XEPDB1
ALTER SESSION SET CONTAINER = XEPDB1;

-- ✅ Comprobamos si el usuario ya existe antes de crear
DECLARE
    v_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO v_count FROM dba_users WHERE username = 'IESS_USER';
    IF v_count = 0 THEN
        EXECUTE IMMEDIATE 'CREATE USER IESS_USER IDENTIFIED BY IESS123 DEFAULT TABLESPACE USERS TEMPORARY TABLESPACE TEMP QUOTA UNLIMITED ON USERS';
        EXECUTE IMMEDIATE 'GRANT CONNECT, RESOURCE TO IESS_USER';
        EXECUTE IMMEDIATE 'GRANT CREATE SESSION, CREATE TABLE, CREATE SEQUENCE, CREATE VIEW, CREATE TRIGGER TO IESS_USER';
    END IF;
END;
/

-- ✅ Crear tablas solo si no existen
BEGIN
    EXECUTE IMMEDIATE '
        CREATE TABLE IESS_USER.CLIENTE (
            CLIENTE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            NOMBRE VARCHAR2(100) NOT NULL,
            GENERO VARCHAR2(20),
            EDAD NUMBER(3),
            IDENTIFICACION VARCHAR2(20) UNIQUE NOT NULL,
            DIRECCION VARCHAR2(150),
            TELEFONO VARCHAR2(20),
            CONTRASENA VARCHAR2(100),
            ESTADO NUMBER(1)
        )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE '
        CREATE TABLE IESS_USER.CUENTA (
            CUENTA_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            CLIENTE_ID NUMBER NOT NULL,
            NUMERO_CUENTA VARCHAR2(20) UNIQUE NOT NULL,
            TIPO_CUENTA     VARCHAR2(20),
            SALDO_INICIAL NUMBER(10,2) DEFAULT 0,
            ESTADO          NUMBER(1),
            CONSTRAINT FK_CLIENTE FOREIGN KEY (CLIENTE_ID)
                REFERENCES IESS_USER.CLIENTE (CLIENTE_ID)
                ON DELETE CASCADE
        )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/

BEGIN
    EXECUTE IMMEDIATE '
        CREATE TABLE IESS_USER.MOVIMIENTO (
            MOVIMIENTO_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            CUENTA_ID NUMBER NOT NULL,
            FECHA DATE DEFAULT SYSDATE,
            TIPO_MOVIMIENTO VARCHAR2(20) CHECK (TIPO_MOVIMIENTO IN (''CREDITO'', ''DEBITO'')),
            VALOR NUMBER(10,2) NOT NULL,
            SALDO_DISPONIBLE NUMBER(10,2),
            CONSTRAINT FK_CUENTA FOREIGN KEY (CUENTA_ID)
                REFERENCES IESS_USER.CUENTA (CUENTA_ID)
                ON DELETE CASCADE
        )';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE = -955 THEN NULL; ELSE RAISE; END IF;
END;
/
